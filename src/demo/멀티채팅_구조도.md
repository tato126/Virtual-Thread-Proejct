# 멀티채팅 서버/클라이언트 구조도

## 1. 전체 구조
```
┌─────────────────────────────────────────────────────────────┐
│                      DemoChatServer                         │
│                       (PORT: 8090)                          │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐  │
│  │         ConcurrentHashMap<String, ClientHandler>      │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │  │
│  │  │   "Alice"   │  │    "Bob"    │  │  "Charlie"  │  │  │
│  │  │      ↓      │  │      ↓      │  │      ↓      │  │  │
│  │  │ClientHandler│  │ClientHandler│  │ClientHandler│  │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  │  │
│  └─────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                    ↑               ↑               ↑
                    │               │               │
              Socket 연결      Socket 연결      Socket 연결
                    │               │               │
                    ↓               ↓               ↓
         ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
         │DemoChatClient│  │DemoChatClient│  │DemoChatClient│
         │   (Alice)    │  │    (Bob)     │  │  (Charlie)   │
         └──────────────┘  └──────────────┘  └──────────────┘
```

## 2. DemoChatServer 동작 흐름
```
┌─────────────────────────────────────────────────────┐
│                  DemoChatServer                     │
├─────────────────────────────────────────────────────┤
│                                                     │
│  1. ServerSocket(8090) 생성                        │
│       │                                             │
│       ▼                                             │
│  2. while(true) - 클라이언트 대기                  │
│       │                                             │
│       ▼                                             │
│  3. socket.accept() - 클라이언트 연결 수락         │
│       │                                             │
│       ▼                                             │
│  4. 가상 스레드 생성                               │
│       Thread.startVirtualThread(ClientHandler)      │
│       │                                             │
│       ▼                                             │
│  ┌─────────────────────────────────────────────┐  │
│  │            ClientHandler.run()               │  │
│  ├─────────────────────────────────────────────┤  │
│  │                                              │  │
│  │  5. 닉네임 요청 → "닉네임을 입력하세요"     │  │
│  │       │                                      │  │
│  │       ▼                                      │  │
│  │  6. 닉네임 수신 & 중복 체크                 │  │
│  │       │                                      │  │
│  │       ▼                                      │  │
│  │  7. clients.put(nickname, this)             │  │
│  │       │                                      │  │
│  │       ▼                                      │  │
│  │  8. 입장 알림 broadcast()                   │  │
│  │       │                                      │  │
│  │       ▼                                      │  │
│  │  9. while(메시지 수신)                      │  │
│  │      - 메시지 읽기                          │  │
│  │      - broadcast(메시지, 발신자)            │  │
│  │       │                                      │  │
│  │       ▼                                      │  │
│  │  10. finally: 퇴장 처리                     │  │
│  │      - clients.remove(nickname)             │  │
│  │      - 퇴장 알림 broadcast()                │  │
│  └─────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
```

## 3. DemoChatClient 동작 흐름
```
┌─────────────────────────────────────────────────────┐
│                  DemoChatClient                     │
├─────────────────────────────────────────────────────┤
│                                                     │
│  1. Socket("localhost", 8090) 연결                 │
│       │                                             │
│       ▼                                             │
│  2. I/O 스트림 생성                                │
│      - BufferedReader (in)                          │
│      - PrintWriter (out)                            │
│      - Scanner                                      │
│       │                                             │
│       ├─────────────────┬──────────────────┐       │
│       ▼                 ▼                  ▼       │
│  ┌─────────┐     ┌──────────┐      ┌──────────┐  │
│  │메인 스레드│     │가상 스레드│      │사용자 입력│  │
│  └─────────┘     └──────────┘      └──────────┘  │
│       │                 │                  │       │
│       ▼                 ▼                  ▼       │
│  3. 닉네임      4. 서버 메시지       키보드 입력   │
│     입력/전송       수신 루프          대기        │
│       │                 │                  │       │
│       ▼                 ▼                  ▼       │
│  5. 메시지         계속 수신 &        메시지 입력  │
│     입력 루프         출력                         │
│       │                 │                  │       │
│       ▼                 ▼                  ▼       │
│  6. /quit 처리    연결 끊김 감지      전송        │
│                                                     │
└─────────────────────────────────────────────────────┘
```

## 4. 메시지 브로드캐스트 흐름
```
Alice가 "안녕하세요" 전송 시:

┌─────────────┐      "안녕하세요"      ┌─────────────┐
│Alice Client │ ──────────────────────▶│   Server    │
└─────────────┘                        └─────────────┘
                                              │
                                              ▼
                                    broadcast() 실행
                                              │
                    ┌─────────────────────────┴─────────────────────────┐
                    ▼                                                   ▼
          "[Alice] 안녕하세요"                              "[Alice] 안녕하세요"
                    │                                                   │
                    ▼                                                   ▼
            ┌─────────────┐                                    ┌─────────────┐
            │ Bob Client  │                                    │Charlie Client│
            └─────────────┘                                    └─────────────┘

※ Alice 자신에게는 전송하지 않음 (sender 제외)
```

## 5. 가상 스레드 활용
```
┌──────────────────────────────────────────────────────┐
│                    서버                              │
│                                                      │
│  메인 스레드          가상 스레드들                  │
│  ┌─────────┐    ┌────────┐ ┌────────┐ ┌────────┐  │
│  │ accept() │    │Alice   │ │Bob     │ │Charlie │  │
│  │  대기    │    │Handler │ │Handler │ │Handler │  │
│  └─────────┘    └────────┘ └────────┘ └────────┘  │
│       │              │          │          │        │
│       │              ▼          ▼          ▼        │
│       │         독립적으로  독립적으로  독립적으로   │
│       │         클라이언트  클라이언트  클라이언트   │
│       ▼           처리        처리        처리      │
│  새 연결 수락                                       │
└──────────────────────────────────────────────────────┘

장점:
- 각 클라이언트가 독립적인 가상 스레드에서 실행
- 블로킹 I/O 작업이 다른 클라이언트에 영향 없음
- 수천 개의 동시 연결 처리 가능
```

## 6. 주요 컴포넌트 관계도
```
┌─────────────────────────────────────────────────┐
│              ConcurrentHashMap                   │
│         (Thread-Safe Collection)                 │
├─────────────────────────────────────────────────┤
│  Key: String (닉네임)                           │
│  Value: ClientHandler (클라이언트 처리 객체)    │
│                                                  │
│  주요 메서드:                                    │
│  - put(): 새 클라이언트 등록                    │
│  - remove(): 클라이언트 제거                    │
│  - containsKey(): 닉네임 중복 체크              │
│  - entrySet(): 모든 클라이언트 순회             │
└─────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────┐
│              ClientHandler                       │
├─────────────────────────────────────────────────┤
│  필드:                                          │
│  - Socket socket                                │
│  - PrintWriter out                              │
│  - String nickname                              │
│                                                  │
│  메서드:                                        │
│  - run(): 클라이언트 처리 로직                  │
│  - sendMessage(): 메시지 전송                   │
│  - broadcast(): 전체 전송 (static)              │
└─────────────────────────────────────────────────┘
```

이 구조도는 DemoChatServer와 DemoChatClient가 어떻게 연결되고, 메시지가 어떻게 흐르며, 가상 스레드가 어떻게 활용되는지를 시각적으로 보여줍니다!